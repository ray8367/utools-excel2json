/**
 * æœ‰é“ç¿»è¯‘æ¥å£
 * https://ai.youdao.com/DOCSIRMA/html/%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E7%BF%BB%E8%AF%91/API%E6%96%87%E6%A1%A3/%E6%96%87%E6%9C%AC%E7%BF%BB%E8%AF%91%E6%9C%8D%E5%8A%A1/%E6%96%87%E6%9C%AC%E7%BF%BB%E8%AF%91%E6%9C%8D%E5%8A%A1-API%E6%96%87%E6%A1%A3.html
 *  */
import SHA256 from 'crypto-js/sha256'
import encHex from 'crypto-js/enc-hex'
import axios from 'axios'
import { getKeyByTag } from '@/store/userSetting'
import { languageCorrectionByTag } from '@/utils/language'

const TAG_NAME = 'youdao'

const errors = {
  101: 'ç¼ºå°‘å¿…å¡«çš„å‚æ•°,é¦–å…ˆç¡®ä¿å¿…å¡«å‚æ•°é½å…¨ï¼Œç„¶åç¡®è®¤å‚æ•°ä¹¦å†™æ˜¯å¦æ­£ç¡®ã€‚',
  102: 'ä¸æ”¯æŒçš„è¯­è¨€ç±»å‹',
  103: 'ç¿»è¯‘æ–‡æœ¬è¿‡é•¿',
  104: 'ä¸æ”¯æŒçš„APIç±»å‹',
  105: 'ä¸æ”¯æŒçš„ç­¾åç±»å‹',
  106: 'ä¸æ”¯æŒçš„å“åº”ç±»å‹',
  107: 'ä¸æ”¯æŒçš„ä¼ è¾“åŠ å¯†ç±»å‹',
  108: 'åº”ç”¨IDæ— æ•ˆï¼Œæ³¨å†Œè´¦å·ï¼Œç™»å½•åå°åˆ›å»ºåº”ç”¨å’Œå®ä¾‹å¹¶å®Œæˆç»‘å®šï¼Œå¯è·å¾—åº”ç”¨IDå’Œåº”ç”¨å¯†é’¥ç­‰ä¿¡æ¯',
  109: 'batchLogæ ¼å¼ä¸æ­£ç¡®',
  110: 'æ— ç›¸å…³æœåŠ¡çš„æœ‰æ•ˆå®ä¾‹,åº”ç”¨æ²¡æœ‰ç»‘å®šæœåŠ¡å®ä¾‹ï¼Œå¯ä»¥æ–°å»ºæœåŠ¡å®ä¾‹ï¼Œç»‘å®šæœåŠ¡å®ä¾‹ã€‚æ³¨ï¼šæŸäº›æœåŠ¡çš„ç¿»è¯‘ç»“æœå‘éŸ³éœ€è¦ttså®ä¾‹ï¼Œéœ€è¦åœ¨æ§åˆ¶å°åˆ›å»ºè¯­éŸ³åˆæˆå®ä¾‹ç»‘å®šåº”ç”¨åæ–¹èƒ½ä½¿ç”¨ã€‚',
  111: 'å¼€å‘è€…è´¦å·æ— æ•ˆ',
  112: 'è¯·æ±‚æœåŠ¡æ— æ•ˆ',
  113: 'qä¸èƒ½ä¸ºç©º',
  114: 'ä¸æ”¯æŒçš„å›¾ç‰‡ä¼ è¾“æ–¹å¼',
  116: 'strictå­—æ®µå–å€¼æ— æ•ˆï¼Œè¯·å‚è€ƒæ–‡æ¡£å¡«å†™æ­£ç¡®å‚æ•°å€¼',
  201: 'è§£å¯†å¤±è´¥ï¼Œå¯èƒ½ä¸ºDES,BASE64,URLDecodeçš„é”™è¯¯',
  202: 'ç­¾åæ£€éªŒå¤±è´¥,å¦‚æœç¡®è®¤åº”ç”¨IDå’Œåº”ç”¨å¯†é’¥çš„æ­£ç¡®æ€§ï¼Œä»è¿”å›202ï¼Œä¸€èˆ¬æ˜¯ç¼–ç é—®é¢˜ã€‚è¯·ç¡®ä¿ç¿»è¯‘æ–‡æœ¬Â qÂ ä¸ºUTF-8ç¼–ç .',
  203: 'è®¿é—®IPåœ°å€ä¸åœ¨å¯è®¿é—®IPåˆ—è¡¨',
  205: 'è¯·æ±‚çš„æ¥å£ä¸åº”ç”¨çš„å¹³å°ç±»å‹ä¸ä¸€è‡´ï¼Œç¡®ä¿æ¥å…¥æ–¹å¼ï¼ˆAndroid SDKã€IOS SDKã€APIï¼‰ä¸åˆ›å»ºçš„åº”ç”¨å¹³å°ç±»å‹ä¸€è‡´ã€‚å¦‚æœ‰ç–‘é—®è¯·å‚è€ƒå…¥é—¨æŒ‡å—',
  206: 'å› ä¸ºæ—¶é—´æˆ³æ— æ•ˆå¯¼è‡´ç­¾åæ ¡éªŒå¤±è´¥',
  207: 'é‡æ”¾è¯·æ±‚',
  301: 'è¾å…¸æŸ¥è¯¢å¤±è´¥',
  302: 'ç¿»è¯‘æŸ¥è¯¢å¤±è´¥',
  303: 'æœåŠ¡ç«¯çš„å…¶å®ƒå¼‚å¸¸',
  304: 'ä¼šè¯é—²ç½®å¤ªä¹…è¶…æ—¶',
  401: 'è´¦æˆ·å·²ç»æ¬ è´¹ï¼Œè¯·è¿›è¡Œè´¦æˆ·å……å€¼',
  402: 'offlinesdkä¸å¯ç”¨',
  411: 'è®¿é—®é¢‘ç‡å—é™,è¯·ç¨åè®¿é—®',
  412: 'é•¿è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åè®¿é—®',
  1001: 'æ— æ•ˆçš„OCRç±»å‹',
  1002: 'ä¸æ”¯æŒçš„OCR imageç±»å‹',
  1003: 'ä¸æ”¯æŒçš„OCR Languageç±»å‹',
  1004: 'è¯†åˆ«å›¾ç‰‡è¿‡å¤§',
  1201: 'å›¾ç‰‡base64è§£å¯†å¤±è´¥',
  1301: 'OCRæ®µè½è¯†åˆ«å¤±è´¥',
  1411: 'è®¿é—®é¢‘ç‡å—é™',
  1412: 'è¶…è¿‡æœ€å¤§è¯†åˆ«å­—èŠ‚æ•°',
  2003: 'ä¸æ”¯æŒçš„è¯­è¨€è¯†åˆ«Languageç±»å‹',
  2004: 'åˆæˆå­—ç¬¦è¿‡é•¿',
  2005: 'ä¸æ”¯æŒçš„éŸ³é¢‘æ–‡ä»¶ç±»å‹',
  2006: 'ä¸æ”¯æŒçš„å‘éŸ³ç±»å‹',
  2201: 'è§£å¯†å¤±è´¥',
  2301: 'æœåŠ¡çš„å¼‚å¸¸',
  2411: 'è®¿é—®é¢‘ç‡å—é™,è¯·ç¨åè®¿é—®',
  2412: 'è¶…è¿‡æœ€å¤§è¯·æ±‚å­—ç¬¦æ•°',
  3001: 'ä¸æ”¯æŒçš„è¯­éŸ³æ ¼å¼',
  3002: 'ä¸æ”¯æŒçš„è¯­éŸ³é‡‡æ ·ç‡',
  3003: 'ä¸æ”¯æŒçš„è¯­éŸ³å£°é“',
  3004: 'ä¸æ”¯æŒçš„è¯­éŸ³ä¸Šä¼ ç±»å‹',
  3005: 'ä¸æ”¯æŒçš„è¯­è¨€ç±»å‹',
  3006: 'ä¸æ”¯æŒçš„è¯†åˆ«ç±»å‹',
  3007: 'è¯†åˆ«éŸ³é¢‘æ–‡ä»¶è¿‡å¤§',
  3008: 'è¯†åˆ«éŸ³é¢‘æ—¶é•¿è¿‡é•¿',
  3009: 'ä¸æ”¯æŒçš„éŸ³é¢‘æ–‡ä»¶ç±»å‹',
  3010: 'ä¸æ”¯æŒçš„å‘éŸ³ç±»å‹',
  3201: 'è§£å¯†å¤±è´¥',
  3301: 'è¯­éŸ³è¯†åˆ«å¤±è´¥',
  3302: 'è¯­éŸ³ç¿»è¯‘å¤±è´¥',
  3303: 'æœåŠ¡çš„å¼‚å¸¸',
  3411: 'è®¿é—®é¢‘ç‡å—é™,è¯·ç¨åè®¿é—®',
  3412: 'è¶…è¿‡æœ€å¤§è¯·æ±‚å­—ç¬¦æ•°',
  4001: 'ä¸æ”¯æŒçš„è¯­éŸ³è¯†åˆ«æ ¼å¼',
  4002: 'ä¸æ”¯æŒçš„è¯­éŸ³è¯†åˆ«é‡‡æ ·ç‡',
  4003: 'ä¸æ”¯æŒçš„è¯­éŸ³è¯†åˆ«å£°é“',
  4004: 'ä¸æ”¯æŒçš„è¯­éŸ³ä¸Šä¼ ç±»å‹',
  4005: 'ä¸æ”¯æŒçš„è¯­è¨€ç±»å‹',
  4006: 'è¯†åˆ«éŸ³é¢‘æ–‡ä»¶è¿‡å¤§',
  4007: 'è¯†åˆ«éŸ³é¢‘æ—¶é•¿è¿‡é•¿',
  4201: 'è§£å¯†å¤±è´¥',
  4301: 'è¯­éŸ³è¯†åˆ«å¤±è´¥',
  4303: 'æœåŠ¡çš„å¼‚å¸¸',
  4411: 'è®¿é—®é¢‘ç‡å—é™,è¯·ç¨åè®¿é—®',
  4412: 'è¶…è¿‡æœ€å¤§è¯·æ±‚æ—¶é•¿',
  5001: 'æ— æ•ˆçš„OCRç±»å‹',
  5002: 'ä¸æ”¯æŒçš„OCR imageç±»å‹',
  5003: 'ä¸æ”¯æŒçš„è¯­è¨€ç±»å‹',
  5004: 'è¯†åˆ«å›¾ç‰‡è¿‡å¤§',
  5005: 'ä¸æ”¯æŒçš„å›¾ç‰‡ç±»å‹',
  5006: 'æ–‡ä»¶ä¸ºç©º',
  5201: 'è§£å¯†é”™è¯¯ï¼Œå›¾ç‰‡base64è§£å¯†å¤±è´¥',
  5301: 'OCRæ®µè½è¯†åˆ«å¤±è´¥',
  5411: 'è®¿é—®é¢‘ç‡å—é™',
  5412: 'è¶…è¿‡æœ€å¤§è¯†åˆ«æµé‡',
  9001: 'ä¸æ”¯æŒçš„è¯­éŸ³æ ¼å¼',
  9002: 'ä¸æ”¯æŒçš„è¯­éŸ³é‡‡æ ·ç‡',
  9003: 'ä¸æ”¯æŒçš„è¯­éŸ³å£°é“',
  9004: 'ä¸æ”¯æŒçš„è¯­éŸ³ä¸Šä¼ ç±»å‹',
  9005: 'ä¸æ”¯æŒçš„è¯­éŸ³è¯†åˆ« Languageç±»å‹',
  9301: 'ASRè¯†åˆ«å¤±è´¥',
  9303: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
  9411: 'è®¿é—®é¢‘ç‡å—é™ï¼ˆè¶…è¿‡æœ€å¤§è°ƒç”¨æ¬¡æ•°ï¼‰',
  9412: 'è¶…è¿‡æœ€å¤§å¤„ç†è¯­éŸ³é•¿åº¦',
  10001: 'æ— æ•ˆçš„OCRç±»å‹',
  10002: 'ä¸æ”¯æŒçš„OCR imageç±»å‹',
  10004: 'è¯†åˆ«å›¾ç‰‡è¿‡å¤§',
  10201: 'å›¾ç‰‡base64è§£å¯†å¤±è´¥',
  10301: 'OCRæ®µè½è¯†åˆ«å¤±è´¥',
  10411: 'è®¿é—®é¢‘ç‡å—é™',
  10412: 'è¶…è¿‡æœ€å¤§è¯†åˆ«æµé‡',
  11001: 'ä¸æ”¯æŒçš„è¯­éŸ³è¯†åˆ«æ ¼å¼',
  11002: 'ä¸æ”¯æŒçš„è¯­éŸ³è¯†åˆ«é‡‡æ ·ç‡',
  11003: 'ä¸æ”¯æŒçš„è¯­éŸ³è¯†åˆ«å£°é“',
  11004: 'ä¸æ”¯æŒçš„è¯­éŸ³ä¸Šä¼ ç±»å‹',
  11005: 'ä¸æ”¯æŒçš„è¯­è¨€ç±»å‹',
  11006: 'è¯†åˆ«éŸ³é¢‘æ–‡ä»¶è¿‡å¤§',
  11007: 'è¯†åˆ«éŸ³é¢‘æ—¶é•¿è¿‡é•¿ï¼Œæœ€å¤§æ”¯æŒ30s',
  11201: 'è§£å¯†å¤±è´¥',
  11301: 'è¯­éŸ³è¯†åˆ«å¤±è´¥',
  11303: 'æœåŠ¡çš„å¼‚å¸¸',
  11411: 'è®¿é—®é¢‘ç‡å—é™,è¯·ç¨åè®¿é—®',
  11412: 'è¶…è¿‡æœ€å¤§è¯·æ±‚æ—¶é•¿',
  12001: 'å›¾ç‰‡å°ºå¯¸è¿‡å¤§',
  12002: 'å›¾ç‰‡base64è§£å¯†å¤±è´¥',
  12003: 'å¼•æ“æœåŠ¡å™¨è¿”å›é”™è¯¯',
  12004: 'å›¾ç‰‡ä¸ºç©º',
  12005: 'ä¸æ”¯æŒçš„è¯†åˆ«å›¾ç‰‡ç±»å‹',
  12006: 'å›¾ç‰‡æ— åŒ¹é…ç»“æœ',
  13001: 'ä¸æ”¯æŒçš„è§’åº¦ç±»å‹',
  13002: 'ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹',
  13003: 'è¡¨æ ¼è¯†åˆ«å›¾ç‰‡è¿‡å¤§',
  13004: 'æ–‡ä»¶ä¸ºç©º',
  13301: 'è¡¨æ ¼è¯†åˆ«å¤±è´¥',
  15001: 'éœ€è¦å›¾ç‰‡',
  15002: 'å›¾ç‰‡è¿‡å¤§ï¼ˆ1Mï¼‰',
  15003: 'æœåŠ¡è°ƒç”¨å¤±è´¥',
  17001: 'éœ€è¦å›¾ç‰‡',
  17002: 'å›¾ç‰‡è¿‡å¤§ï¼ˆ1Mï¼‰',
  17003: 'è¯†åˆ«ç±»å‹æœªæ‰¾åˆ°',
  17004: 'ä¸æ”¯æŒçš„è¯†åˆ«ç±»å‹',
  17005: 'æœåŠ¡è°ƒç”¨å¤±è´¥'
}
const last = {
  optionsStr: '',
  result: ''
}

/**
 * é€šç”¨ç¿»è¯‘
 * @param {String} options.q è¯·æ±‚ç¿»è¯‘query(UTF-8ç¼–ç )
 * @param {String} options.from ç¿»è¯‘æºè¯­è¨€(å¯è®¾ç½®ä¸ºauto)
 * @param {String} options.to ç¿»è¯‘ç›®æ ‡è¯­è¨€ (å¯è®¾ç½®ä¸ºauto)
 * @param {Boolean} options.isRefresh å¼ºåˆ¶åˆ·æ–°
 */
export default function (options) {
  let { q, isRefresh } = options

  // ç©ºå€¼ä¼˜åŒ–
  if (!q) {
    return ''
  }

  // é‡å¤å€¼ä¼˜åŒ–
  const optionsStr = JSON.stringify(options)

  // è¯­è¨€ä¿®æ­£
  let { from, to } = languageCorrectionByTag(TAG_NAME, options)

  if (!isRefresh && optionsStr === last.optionsStr) {
    return last.result
  }
  last.optionsStr = optionsStr

  const url = import.meta.env.VITE_YOUDAO_BASEURL
  const keyConfig = getKeyByTag(TAG_NAME)
  if (!keyConfig || !keyConfig.appid || !keyConfig.appkey) {
    const result = {
      code: 199,
      text:
        'ç¿»è¯‘å¤±è´¥ï¼š' +
        'ğŸš¨æ²¡æœ‰é…ç½®æœåŠ¡å“¦ï¼Œæˆ‘çŒœä½ å¤§æ¦‚ç‡æ˜¯æ²¡æœ‰å¡«æœ‰é“ç¿»è¯‘çš„ä¿¡æ¯ï¼Œç°åœ¨ï¼Œä½ åº”è¯¥é©¬ä¸åœè¹„çš„ç‚¹å‡»å³ä¸‹è§’çš„è®¾ç½®æŒ‰é’®ï¼Œå»å¡«å†™ç›¸å…³ä¿¡æ¯ğŸš§'
    }
    last.result = result
    return result
  }

  const { appid, appkey } = keyConfig
  // ç­¾å
  const { sign, salt, curtime } = toSign(appid, appkey, q)

  const params = {
    q,
    from,
    to,
    appKey: appid,
    salt: salt,
    sign: sign,
    signType: 'v3',
    curtime: curtime
  }

  return axios
    .get(url, { params })
    .then(res => {
      const { translation, errorCode } = res.data
      let result
      if (errorCode === '0') {
        // ç¿»è¯‘æˆåŠŸ
        let text = ''
        translation.map(item => {
          text += item + '\n'
        })
        result = {
          code: 200,
          text: text
        }
      } else {
        // ç¿»è¯‘å¤±è´¥
        result = {
          code: 199,
          text: errorCode + 'ï¼š' + errors[errorCode] || 'ç¿»è¯‘å¤±è´¥'
        }
      }
      last.result = result
      return result
    })
    .catch(err => {
      const result = {
        code: 199,
        text: 'ç¿»è¯‘å¤±è´¥ï¼š' + err.message
      }
      last.result = result
      return result
    })
}

/** ç­¾å */
function toSign(appid, appkey, query) {
  const salt = new Date().getTime()
  const curtime = Math.round(new Date().getTime() / 1000)
  const str1 = appid + truncate(query) + salt + curtime + appkey
  const sign = SHA256(str1).toString(encHex)
  return {
    sign,
    salt,
    curtime
  }

  function truncate(q) {
    const len = q.length
    if (len <= 20) return q
    return q.substring(0, 10) + len + q.substring(len - 10, len)
  }
}
